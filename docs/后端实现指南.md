# 🔧 尺码表生成器 - 本地后端实现指南

## 📊 项目状况

### 前端现状
- React 18 + Styled Components 架构完善
- 智能类型识别功能正常 (100% 测试通过)
- 当前使用 localStorage 存储数据

### 后端目标
- SQLite 本地数据库替代 localStorage
- Excel 导出功能
- 文件系统集成
- 数据备份恢复

---

## 🚀 实施方案

### 技术架构
```
React 前端 ↔ Electron IPC ↔ SQLite 数据库
```

### 核心技术栈
- **数据库**: SQLite3 + better-sqlite3
- **导出**: ExcelJS
- **桌面**: Electron (已配置)
- **文件**: Node.js fs + path

---

## 📦 第一步：安装依赖

```bash
cd "d:\桌面\编程\chi-ma-biao-7.16"

# 安装所有依赖
npm install better-sqlite3 exceljs --save

# 开发依赖（可选）
npm install @types/better-sqlite3 --save-dev
```

---

## 📁 第二步：创建数据库服务

### 1. SQLite 数据库服务 (`src/services/localDatabase.js`)

```javascript
const Database = require('better-sqlite3');
const path = require('path');
const fs = require('fs');
const os = require('os');

class LocalDatabase {
  constructor() {
    this.appDir = path.join(os.homedir(), 'Documents', '尺码表生成器');
    this.dbPath = path.join(this.appDir, 'data.db');
    this.init();
  }
  
  init() {
    // 确保目录存在
    if (!fs.existsSync(this.appDir)) {
      fs.mkdirSync(this.appDir, { recursive: true });
    }
    
    // 初始化数据库
    this.db = new Database(this.dbPath);
    this.db.pragma('journal_mode = WAL');
    this.createTables();
  }
  
  createTables() {
    this.db.exec(`
      CREATE TABLE IF NOT EXISTS categories (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        type TEXT NOT NULL,
        base_value REAL NOT NULL,
        base_increment REAL NOT NULL,
        description TEXT DEFAULT '',
        is_custom INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );
      
      CREATE TABLE IF NOT EXISTS size_charts (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        mode TEXT DEFAULT 'normal',
        config TEXT NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );
      
      CREATE TABLE IF NOT EXISTS app_settings (
        key TEXT PRIMARY KEY,
        value TEXT NOT NULL,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );
    `);
  }
  
  // 类别操作
  createCategory(data) {
    const stmt = this.db.prepare(`
      INSERT INTO categories (name, type, base_value, base_increment, description, is_custom)
      VALUES (?, ?, ?, ?, ?, ?)
    `);
    return stmt.run(data.name, data.type, data.baseValue, data.baseIncrement, data.description || '', data.isCustom ? 1 : 0);
  }
  
  getCategories() {
    const categories = this.db.prepare('SELECT * FROM categories ORDER BY is_custom, created_at').all();
    // 将数据库字段名转换为驼峰命名
    return categories.map(cat => ({
      id: cat.id,
      name: cat.name,
      type: cat.type,
      baseValue: cat.base_value,
      baseIncrement: cat.base_increment,
      description: cat.description,
      isCustom: Boolean(cat.is_custom),
      createdAt: cat.created_at
    }));
  }
  
  updateCategory(id, updates) {
    // 映射驼峰命名到数据库字段名，同时进行白名单验证
    const fieldMap = {
      name: 'name',
      type: 'type', 
      baseValue: 'base_value',
      baseIncrement: 'base_increment',
      description: 'description',
      isCustom: 'is_custom'
    };
    
    const dbUpdates = {};
    Object.keys(updates).forEach(key => {
      if (fieldMap[key]) {  // 白名单验证
        const dbKey = fieldMap[key];
        dbUpdates[dbKey] = updates[key];
      }
    });
    
    if (Object.keys(dbUpdates).length === 0) {
      throw new Error('没有有效的更新字段');
    }
    
    const fields = Object.keys(dbUpdates).map(key => `${key} = ?`).join(', ');
    const values = [...Object.values(dbUpdates), id];
    return this.db.prepare(`UPDATE categories SET ${fields}, updated_at = CURRENT_TIMESTAMP WHERE id = ?`).run(...values);
  }
  
  deleteCategory(id) {
    return this.db.prepare('DELETE FROM categories WHERE id = ?').run(id);
  }
  
  // 尺码表操作
  createSizeChart(data) {
    const stmt = this.db.prepare(`
      INSERT INTO size_charts (name, mode, config)
      VALUES (?, ?, ?)
    `);
    return stmt.run(data.name, data.mode || 'normal', JSON.stringify(data.config));
  }
  
  getSizeCharts() {
    const charts = this.db.prepare('SELECT * FROM size_charts ORDER BY created_at DESC').all();
    return charts.map(chart => {
      let config;
      try {
        config = JSON.parse(chart.config);
      } catch (error) {
        console.error('解析尺码表配置失败:', error);
        config = {};
      }
      return {
        id: chart.id,
        name: chart.name,
        mode: chart.mode,
        config: config,
        createdAt: chart.created_at
      };
    });
  }
  
  updateSizeChart(id, updates) {
    const fields = [];
    const values = [];
    
    // 白名单验证更新字段
    const allowedFields = ['name', 'mode', 'config'];
    
    if (updates.name && allowedFields.includes('name')) {
      fields.push('name = ?');
      values.push(updates.name);
    }
    if (updates.mode && allowedFields.includes('mode')) {
      fields.push('mode = ?');
      values.push(updates.mode);
    }
    if (updates.config && allowedFields.includes('config')) {
      fields.push('config = ?');
      values.push(JSON.stringify(updates.config));
    }
    
    if (fields.length === 0) {
      throw new Error('没有有效的更新字段');
    }
    
    values.push(id);
    return this.db.prepare(`UPDATE size_charts SET ${fields.join(', ')} WHERE id = ?`).run(...values);
  }
  
  deleteSizeChart(id) {
    return this.db.prepare('DELETE FROM size_charts WHERE id = ?').run(id);
  }
  
  // 设置操作
  setSetting(key, value) {
    return this.db.prepare(`
      INSERT OR REPLACE INTO app_settings (key, value, updated_at)
      VALUES (?, ?, CURRENT_TIMESTAMP)
    `).run(key, JSON.stringify(value));
  }
  
  getSetting(key, defaultValue = null) {
    const result = this.db.prepare('SELECT value FROM app_settings WHERE key = ?').get(key);
    if (result) {
      try {
        return JSON.parse(result.value);
      } catch (error) {
        console.error('解析设置值失败:', error);
        return defaultValue;
      }
    }
    return defaultValue;
  }
  
  close() {
    if (this.db) this.db.close();
  }
}

module.exports = LocalDatabase;
```

### 2. 数据迁移工具 (`src/services/dataMigration.js`)

```javascript
class DataMigration {
  constructor(database) {
    this.db = database;
  }
  
  // 从前端传递的 localStorage 数据进行迁移
  migrateFromLocalStorage(localStorageData) {
    try {
      // 迁移自定义类别
      const customCategories = localStorageData.customCategories || [];
      customCategories.forEach(category => {
        // 验证必需字段
        if (!category.name || !category.type || category.baseValue === undefined || category.baseIncrement === undefined) {
          console.warn('跳过无效类别数据:', category);
          return;
        }
        
        this.db.createCategory({
          name: category.name,
          type: category.type,
          baseValue: parseFloat(category.baseValue) || 0,
          baseIncrement: parseFloat(category.baseIncrement) || 0,
          description: category.description || '',
          isCustom: true
        });
      });
      
      // 迁移尺码表
      const sizeCharts = localStorageData.sizeCharts || [];
      sizeCharts.forEach(chart => {
        this.db.createSizeChart({
          name: chart.name || '未命名尺码表',
          mode: chart.mode || 'normal',
          config: chart.config || chart
        });
      });
      
      // 迁移设置
      const settingsKeys = ['sizeSettings', 'categoryStartValues', 'mode'];
      settingsKeys.forEach(key => {
        if (localStorageData[key]) {
          this.db.setSetting(key, localStorageData[key]);
        }
      });
      
      return { success: true, message: '数据迁移完成' };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }
  
  // 检查是否需要迁移（由前端调用）
  checkMigrationStatus() {
    try {
      // 检查数据库是否为空（需要迁移）
      const existingCategories = this.db.getCategories().filter(cat => cat.isCustom);
      const existingCharts = this.db.getSizeCharts();
      
      // 如果数据库中没有自定义类别和尺码表，则需要迁移
      return existingCategories.length === 0 && existingCharts.length === 0;
    } catch (error) {
      console.error('检查迁移状态失败:', error);
      return false;
    }
  }
}

module.exports = DataMigration;
```

---

## 🔧 第三步：更新 Electron 主进程

### 更新 `electron/main.js` (或 `src/main.js`)

```javascript
const { app, BrowserWindow, ipcMain, dialog } = require('electron');
const path = require('path');
const LocalDatabase = require('../src/services/localDatabase');
const DataMigration = require('../src/services/dataMigration');
const ExcelExporter = require('../src/services/excelExporter');

let mainWindow, database, migration, excelExporter;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js')
    }
  });

  const isDev = process.env.NODE_ENV === 'development';
  mainWindow.loadURL(isDev ? 'http://localhost:5173' : `file://${path.join(__dirname, '../dist/index.html')}`);
  if (isDev) mainWindow.webContents.openDevTools();
}

app.whenReady().then(() => {
  database = new LocalDatabase();
  migration = new DataMigration(database);
  excelExporter = new ExcelExporter();
  createWindow();
});

app.on('window-all-closed', () => {
  if (database) database.close();
  if (process.platform !== 'darwin') app.quit();
});

app.on('activate', () => {
  if (BrowserWindow.getAllWindows().length === 0) {
    createWindow();
  }
});

// IPC 处理
const wrapHandler = (fn) => async (event, ...args) => {
  try {
    const result = await fn(...args);
    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: error.message };
  }
};

ipcMain.handle('db-create-category', wrapHandler((data) => database.createCategory(data)));
ipcMain.handle('db-get-categories', wrapHandler(() => database.getCategories()));
ipcMain.handle('db-update-category', wrapHandler((id, updates) => database.updateCategory(id, updates)));
ipcMain.handle('db-delete-category', wrapHandler((id) => database.deleteCategory(id)));

ipcMain.handle('db-create-size-chart', wrapHandler((data) => database.createSizeChart(data)));
ipcMain.handle('db-get-size-charts', wrapHandler(() => database.getSizeCharts()));
ipcMain.handle('db-update-size-chart', wrapHandler((id, updates) => database.updateSizeChart(id, updates)));
ipcMain.handle('db-delete-size-chart', wrapHandler((id) => database.deleteSizeChart(id)));

ipcMain.handle('db-set-setting', wrapHandler((key, value) => database.setSetting(key, value)));
ipcMain.handle('db-get-setting', wrapHandler((key, defaultValue) => database.getSetting(key, defaultValue)));
ipcMain.handle('migrate-data', wrapHandler((localStorageData) => migration.migrateFromLocalStorage(localStorageData)));
ipcMain.handle('check-migration-status', wrapHandler(() => migration.checkMigrationStatus()));
```

### 创建 `electron/preload.js`

```javascript
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('electronAPI', {
  // 数据库操作 - 类别
  dbCreateCategory: (data) => ipcRenderer.invoke('db-create-category', data),
  dbGetCategories: () => ipcRenderer.invoke('db-get-categories'),
  dbUpdateCategory: (id, updates) => ipcRenderer.invoke('db-update-category', id, updates),
  dbDeleteCategory: (id) => ipcRenderer.invoke('db-delete-category', id),
  
  // 数据库操作 - 尺码表
  dbCreateSizeChart: (data) => ipcRenderer.invoke('db-create-size-chart', data),
  dbGetSizeCharts: () => ipcRenderer.invoke('db-get-size-charts'),
  dbUpdateSizeChart: (id, updates) => ipcRenderer.invoke('db-update-size-chart', id, updates),
  dbDeleteSizeChart: (id) => ipcRenderer.invoke('db-delete-size-chart', id),
  
  // 设置操作
  dbSetSetting: (key, value) => ipcRenderer.invoke('db-set-setting', key, value),
  dbGetSetting: (key, defaultValue) => ipcRenderer.invoke('db-get-setting', key, defaultValue),
  
  // 数据迁移
  migrateData: (localStorageData) => ipcRenderer.invoke('migrate-data', localStorageData),
  checkMigrationStatus: () => ipcRenderer.invoke('check-migration-status'),
  
  // 文件操作
  showSaveDialog: (options) => ipcRenderer.invoke('show-save-dialog', options),
  exportExcel: (data) => ipcRenderer.invoke('export-excel', data)
});
```

---

## 🔄 第四步：更新前端数据访问

### 更新 `src/services/dataManager.js`

```javascript
// 检查是否在 Electron 环境
const isElectron = window.electronAPI;

// 原有接口保持不变，内部实现切换
export const createCategory = async (categoryData) => {
  if (isElectron) {
    const result = await window.electronAPI.dbCreateCategory(categoryData);
    if (!result.success) throw new Error(result.error);
    return result.data;
  } else {
    // 降级到 localStorage (开发环境)
    return createCategoryLocal(categoryData);
  }
};

export const getCategories = async () => {
  if (isElectron) {
    const result = await window.electronAPI.dbGetCategories();
    return result.success ? result.data : [];
  } else {
    return getCategoriesLocal();
  }
};

export const updateCategory = async (id, updates) => {
  if (isElectron) {
    const result = await window.electronAPI.dbUpdateCategory(id, updates);
    if (!result.success) throw new Error(result.error);
    return result.data;
  } else {
    // 降级到 localStorage (开发环境)
    return updateCategoryLocal(id, updates);
  }
};

export const deleteCategory = async (id) => {
  if (isElectron) {
    const result = await window.electronAPI.dbDeleteCategory(id);
    if (!result.success) throw new Error(result.error);
    return result.data;
  } else {
    // 降级到 localStorage (开发环境)
    return deleteCategoryLocal(id);
  }
};

// 尺码表操作
export const createSizeChart = async (chartData) => {
  if (isElectron) {
    const result = await window.electronAPI.dbCreateSizeChart(chartData);
    if (!result.success) throw new Error(result.error);
    return result.data;
  } else {
    // 降级到 localStorage (开发环境)
    return createSizeChartLocal(chartData);
  }
};

export const getSizeCharts = async () => {
  if (isElectron) {
    const result = await window.electronAPI.dbGetSizeCharts();
    return result.success ? result.data : [];
  } else {
    return getSizeChartsLocal();
  }
};

export const updateSizeChart = async (id, updates) => {
  if (isElectron) {
    const result = await window.electronAPI.dbUpdateSizeChart(id, updates);
    if (!result.success) throw new Error(result.error);
    return result.data;
  } else {
    // 降级到 localStorage (开发环境)
    return updateSizeChartLocal(id, updates);
  }
};

export const deleteSizeChart = async (id) => {
  if (isElectron) {
    const result = await window.electronAPI.dbDeleteSizeChart(id);
    if (!result.success) throw new Error(result.error);
    return result.data;
  } else {
    // 降级到 localStorage (开发环境)
    return deleteSizeChartLocal(id);
  }
};

// localStorage 降级函数 (保留现有逻辑作为备用)
const createCategoryLocal = (categoryData) => {
  try {
    const categories = JSON.parse(localStorage.getItem('customCategories') || '[]');
    const newCategory = { ...categoryData, id: Date.now(), createdAt: new Date().toISOString() };
    categories.push(newCategory);
    localStorage.setItem('customCategories', JSON.stringify(categories));
    return newCategory;
  } catch (error) {
    console.error('localStorage 操作失败:', error);
    throw error;
  }
};

const getCategoriesLocal = () => {
  try {
    return JSON.parse(localStorage.getItem('customCategories') || '[]');
  } catch (error) {
    console.error('读取 localStorage 失败:', error);
    return [];
  }
};

const updateCategoryLocal = (id, updates) => {
  try {
    const categories = JSON.parse(localStorage.getItem('customCategories') || '[]');
    const index = categories.findIndex(cat => cat.id === id);
    if (index !== -1) {
      categories[index] = { ...categories[index], ...updates, updatedAt: new Date().toISOString() };
      localStorage.setItem('customCategories', JSON.stringify(categories));
      return categories[index];
    }
    throw new Error('类别不存在');
  } catch (error) {
    console.error('更新 localStorage 失败:', error);
    throw error;
  }
};

const deleteCategoryLocal = (id) => {
  try {
    const categories = JSON.parse(localStorage.getItem('customCategories') || '[]');
    const filteredCategories = categories.filter(cat => cat.id !== id);
    localStorage.setItem('customCategories', JSON.stringify(filteredCategories));
    return { success: true };
  } catch (error) {
    console.error('删除 localStorage 失败:', error);
    throw error;
  }
};

// 尺码表 localStorage 降级函数
const createSizeChartLocal = (chartData) => {
  try {
    const charts = JSON.parse(localStorage.getItem('sizeCharts') || '[]');
    const newChart = { ...chartData, id: Date.now(), createdAt: new Date().toISOString() };
    charts.push(newChart);
    localStorage.setItem('sizeCharts', JSON.stringify(charts));
    return newChart;
  } catch (error) {
    console.error('localStorage 操作失败:', error);
    throw error;
  }
};

const getSizeChartsLocal = () => {
  try {
    return JSON.parse(localStorage.getItem('sizeCharts') || '[]');
  } catch (error) {
    console.error('读取 localStorage 失败:', error);
    return [];
  }
};

const updateSizeChartLocal = (id, updates) => {
  try {
    const charts = JSON.parse(localStorage.getItem('sizeCharts') || '[]');
    const index = charts.findIndex(chart => chart.id === id);
    if (index !== -1) {
      charts[index] = { ...charts[index], ...updates, updatedAt: new Date().toISOString() };
      localStorage.setItem('sizeCharts', JSON.stringify(charts));
      return charts[index];
    }
    throw new Error('尺码表不存在');
  } catch (error) {
    console.error('更新 localStorage 失败:', error);
    throw error;
  }
};

const deleteSizeChartLocal = (id) => {
  try {
    const charts = JSON.parse(localStorage.getItem('sizeCharts') || '[]');
    const filteredCharts = charts.filter(chart => chart.id !== id);
    localStorage.setItem('sizeCharts', JSON.stringify(filteredCharts));
    return { success: true };
  } catch (error) {
    console.error('删除 localStorage 失败:', error);
    throw error;
  }
};

// 数据迁移检查
export const checkAndMigrate = async () => {
  if (isElectron) {
    try {
      // 检查是否有本地数据需要迁移
      const hasLocalData = localStorage.getItem('customCategories') || 
                          localStorage.getItem('sizeSettings') ||
                          localStorage.getItem('categoryStartValues') ||
                          localStorage.getItem('mode');
      
      if (!hasLocalData) return false;
      
      // 检查数据库是否需要迁移
      const statusResult = await window.electronAPI.checkMigrationStatus();
      if (!statusResult.success || !statusResult.data) return false;
      
      // 收集 localStorage 数据
      const localStorageData = {};
      
      try {
        localStorageData.customCategories = JSON.parse(localStorage.getItem('customCategories') || '[]');
      } catch {
        localStorageData.customCategories = [];
      }
      
      try {
        localStorageData.sizeCharts = JSON.parse(localStorage.getItem('sizeCharts') || '[]');
      } catch {
        localStorageData.sizeCharts = [];
      }
      
      try {
        localStorageData.sizeSettings = JSON.parse(localStorage.getItem('sizeSettings') || '{}');
      } catch {
        localStorageData.sizeSettings = {};
      }
      
      try {
        localStorageData.categoryStartValues = JSON.parse(localStorage.getItem('categoryStartValues') || '{}');
      } catch {
        localStorageData.categoryStartValues = {};
      }
      
      localStorageData.mode = localStorage.getItem('mode') || 'normal';
      
      // 执行迁移
      const result = await window.electronAPI.migrateData(localStorageData);
      if (result.success) {
        // 清理 localStorage
        ['customCategories', 'sizeCharts', 'sizeSettings', 'categoryStartValues', 'mode'].forEach(key => {
          localStorage.removeItem(key);
        });
        console.log('数据迁移完成');
        return true;
      }
    } catch (error) {
      console.error('数据迁移失败:', error);
    }
  }
  return false;
};
```

---

## 📄 第五步：导出功能实现

### Excel 导出服务 (`src/services/excelExporter.js`)

```javascript
const ExcelJS = require('exceljs');

class ExcelExporter {
  async exportSizeChart(chartData, filePath) {
    if (!chartData || chartData.length === 0) {
      throw new Error('没有数据可导出');
    }
    
    const workbook = new ExcelJS.Workbook();
    workbook.creator = '尺码表生成器';
    workbook.created = new Date();
    
    const worksheet = workbook.addWorksheet('尺码表');
    
    // 设置表头样式
    const headers = Object.keys(chartData[0]);
    const headerRow = worksheet.getRow(1);
    headers.forEach((header, index) => {
      const cell = headerRow.getCell(index + 1);
      cell.value = header;
      cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
      cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF366092' } };
      cell.alignment = { horizontal: 'center', vertical: 'middle' };
    });
    
    // 添加数据
    chartData.forEach((row, rowIndex) => {
      const dataRow = worksheet.getRow(rowIndex + 2);
      headers.forEach((header, colIndex) => {
        dataRow.getCell(colIndex + 1).value = row[header];
      });
    });
    
    // 自动调整列宽
    worksheet.columns.forEach(column => {
      column.width = 15;
    });
    
    // 添加边框
    const borderStyle = { style: 'thin' };
    for (let row = 1; row <= chartData.length + 1; row++) {
      for (let col = 1; col <= headers.length; col++) {
        worksheet.getCell(row, col).border = {
          top: borderStyle,
          left: borderStyle,
          bottom: borderStyle,
          right: borderStyle
        };
      }
    }
    
    await workbook.xlsx.writeFile(filePath);
    return { success: true, filePath };
  }
}

module.exports = ExcelExporter;
```

### 在 main.js 中添加导出处理

// 添加文件对话框处理
ipcMain.handle('show-save-dialog', async (event, options) => {
  try {
    const result = await dialog.showSaveDialog(mainWindow, {
      filters: [{ name: 'Excel Files', extensions: ['xlsx'] }],
      defaultPath: `尺码表_${new Date().toISOString().split('T')[0]}.xlsx`,
      ...options
    });
    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: error.message };
  }
});

// 导出 Excel 处理
ipcMain.handle('export-excel', async (event, data) => {
  try {
    // 验证数据格式
    if (!data || !data.chartData || !Array.isArray(data.chartData) || data.chartData.length === 0) {
      return { success: false, error: '无效的导出数据' };
    }
    
    // 先显示保存对话框
    const dialogResult = await dialog.showSaveDialog(mainWindow, {
      filters: [{ name: 'Excel Files', extensions: ['xlsx'] }],
      defaultPath: `尺码表_${new Date().toISOString().split('T')[0]}.xlsx`
    });
    
    if (dialogResult.canceled) {
      return { success: false, message: '用户取消保存' };
    }
    
    // 执行导出
    const result = await excelExporter.exportSizeChart(data.chartData, dialogResult.filePath);
    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: error.message };
  }
});
```javascript
const LocalDatabase = require('../src/services/localDatabase');

async function testDatabase() {
  console.log('🧪 测试 SQLite 数据库...\n');
  
  const db = new LocalDatabase();
  
  try {
    // 测试创建类别
    const result = db.createCategory({
      name: '测试胸围',
      type: 'chest',
      baseValue: 88,
      baseIncrement: 4,
      description: '测试类别',
      isCustom: true
    });
    console.log('✅ 创建类别成功, ID:', result.lastInsertRowid);
    
    // 测试获取类别
    const categories = db.getCategories();
    console.log('✅ 获取类别:', categories.length, '个');
    console.log('   示例数据:', categories[0]);
    
    // 测试更新类别
    if (categories.length > 0) {
      const updateResult = db.updateCategory(categories[0].id, { 
        baseValue: 90,
        description: '更新的测试类别' 
      });
      console.log('✅ 更新类别成功');
    }
    
    // 测试设置
    db.setSetting('testSetting', { mode: 'normal', count: 4 });
    const setting = db.getSetting('testSetting');
    console.log('✅ 设置测试:', setting);
    
    console.log('\n🎉 所有测试通过！');
  } catch (error) {
    console.error('❌ 测试失败:', error);
  } finally {
    db.close();
  }
}

// 立即执行测试
testDatabase();
```

---

## 📋 执行清单

### 立即执行
1. **安装依赖**: `npm install better-sqlite3 exceljs --save`
2. **创建文件**: 按上述代码创建所有服务文件
3. **测试数据库**: `node test/test-sqlite.js`
4. **更新前端**: 修改 dataManager.js 支持数据库调用
5. **启动应用**: `npm run electron` 验证功能

### 验收标准
- SQLite 数据库文件创建在 `~/Documents/尺码表生成器/data.db`
- 前端可以正常创建、读取、更新、删除类别
- localStorage 数据自动迁移到数据库
- Excel 导出功能可用
- 应用运行稳定，无数据丢失

### 文件结构
```text
src/
├── services/
│   ├── localDatabase.js     # SQLite 数据库服务
│   ├── dataMigration.js     # 数据迁移工具
│   ├── excelExporter.js     # Excel 导出服务
│   └── dataManager.js       # 前端数据访问层 (更新)
├── electron/
│   ├── main.js              # Electron 主进程 (更新)
│   └── preload.js           # 安全通信层 (新建)
└── test/
    └── test-sqlite.js       # 数据库测试 (新建)
```

---

## 🎯 核心优势

- **可靠存储**: SQLite 替代 localStorage，数据永不丢失
- **离线使用**: 完全本地化，无需网络连接
- **专业导出**: Excel 高质量文件输出
- **向后兼容**: 自动迁移现有数据，用户无感知
- **易于维护**: 技术栈简单，扩展性强

完成以上步骤后，你的尺码表生成器将拥有企业级的数据可靠性和专业的导出功能！
