# 单实例运行功能修复报告

## 📋 问题描述
- **问题**：程序已经打开的情况下，再次双击图标会再开一个程序界面，可以无限多开
- **期望行为**：只允许运行一个程序实例，再次双击图标应该将已打开的程序切换到前台

## 🔧 解决方案

### 技术实现
在 `main.cjs` 中添加了单实例检查机制，使用 Electron 的 `app.requestSingleInstanceLock()` API。

### 代码修改

```javascript
/**
 * 设置单实例运行
 */
setupSingleInstance() {
  const gotTheLock = app.requestSingleInstanceLock();

  if (!gotTheLock) {
    // 如果获取锁失败，说明已经有实例在运行，退出当前实例
    console.log('应用已在运行，退出当前实例');
    app.quit();
    return;
  }

  // 当第二个实例试图启动时，聚焦到第一个实例
  app.on('second-instance', (event, commandLine, workingDirectory) => {
    console.log('检测到第二个实例启动，聚焦到主窗口');
    
    // 如果主窗口存在，则聚焦并显示
    if (this.mainWindow) {
      // 如果窗口被最小化，恢复它
      if (this.mainWindow.isMinimized()) {
        this.mainWindow.restore();
      }
      
      // 聚焦并显示在最前面
      this.mainWindow.focus();
      this.mainWindow.show();
      
      // 确保窗口显示在所有其他窗口前面
      this.mainWindow.setAlwaysOnTop(true);
      this.mainWindow.setAlwaysOnTop(false);
    }
  });
}
```

## 🎯 功能特性

### 1. **单实例保护**
- 只允许运行一个应用程序实例
- 第二个实例启动时自动退出

### 2. **智能前台切换**
- 再次双击图标时，已打开的程序会切换到前台
- 如果程序被最小化，会自动恢复窗口
- 确保程序显示在所有其他窗口前面

### 3. **用户体验优化**
- 避免了意外多开程序
- 提供了直观的程序访问方式
- 保持了系统资源的有效使用

## ⚙️ 工作流程

1. **首次启动**：
   - 程序获取单实例锁
   - 正常创建窗口并显示

2. **再次启动**：
   - 新实例尝试获取锁失败
   - 触发 `second-instance` 事件
   - 聚焦到已存在的窗口
   - 新实例自动退出

3. **窗口状态处理**：
   - 最小化窗口：自动恢复
   - 后台窗口：切换到前台
   - 确保窗口可见性

## 📦 版本信息
- **修复版本**：v1.1.0
- **修复时间**：2025年8月6日
- **影响文件**：main.cjs

## ✅ 测试建议

1. **基本功能测试**：
   - 启动程序，确认正常运行
   - 再次双击图标，确认不会开启新实例
   - 验证已打开的程序切换到前台

2. **窗口状态测试**：
   - 最小化程序后双击图标，确认窗口恢复
   - 将程序置于后台后双击图标，确认切换到前台

3. **极端情况测试**：
   - 快速多次双击图标
   - 程序启动过程中双击图标

## 🚀 部署说明

新的安装包文件：
- `集领尺码表生成器-Setup-1.1.0.exe` (安装包)
- `集领尺码表生成器-1.1.0-portable.exe` (便携版)

安装新版本后，单实例功能将自动生效，无需额外配置。

## 📝 注意事项

- 此功能在所有平台（Windows、macOS、Linux）上都有效
- 不影响程序的其他功能
- 兼容现有的用户数据和设置
